<!-- ===== COMPREHENSIVE METRICS DASHBOARD ===== -->
<section id="metrics" class="page-section metrics-dashboard">

  {% set dm = report.detailed_metrics %}

  <!-- Header -->
  <div class="metrics-header d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="section-title mb-1">
        <i class="bi bi-clipboard-data"></i> Comprehensive Metrics Dashboard
      </h2>
      <p class="metrics-subtitle mb-0">
        A high-level, finance-grade view of your risk, performance and trade quality.
      </p>
    </div>
    <div class="metrics-badge">
      <span class="badge rounded-pill bg-soft-primary text-primary">
        <i class="bi bi-shield-check me-1"></i> Trader Persona Analytics
      </span>
    </div>
  </div>

  <!-- Layout: 2 columns on desktop -->
  <div class="row g-4 metrics-layout">

    <!-- ========== LEFT COLUMN (core performance + risk + win/loss) ========== -->
    <div class="col-lg-8 d-flex flex-column gap-4">

      <!-- PERFORMANCE OVERVIEW -->
      <div class="metrics-block card-finance">
        <div class="metrics-block-header">
          <div>
            <span class="block-tag tag-performance">Performance</span>
            <h5>Risk-Adjusted Performance</h5>
            <p class="block-subtext">How efficiently your capital is converting into returns.</p>
          </div>
        </div>

        <div class="row g-3 mt-2">
          <!-- Sortino -->
          <div class="col-md-4">
            <div class="metric-chip">
              <div class="metric-chip-label">Sortino Ratio</div>
              <div class="metric-chip-value">
                {{ '%.2f'|format(dm.sortino_ratio or 0) }}
              </div>
              <div class="metric-chip-sub">Returns vs downside risk</div>
            </div>
          </div>

          <!-- ROC -->
          <div class="col-md-4">
            <div class="metric-chip">
              <div class="metric-chip-label">Return on Capital</div>
              <div class="metric-chip-value {{ 'text-success' if (dm.return_on_capital or 0)>0 else 'text-danger' }}">
                {{ '%.2f'|format(dm.return_on_capital or 0) }}%
              </div>
              <div class="metric-chip-sub">Net PnL ÷ capital deployed</div>
            </div>
          </div>

          <!-- Efficiency -->
          <div class="col-md-4">
            <div class="metric-chip">
              <div class="metric-chip-label">Efficiency Ratio</div>
              <div class="metric-chip-value">
                {{ '%.2f'|format(dm.efficiency_ratio or 0) }}
              </div>
              <div class="metric-chip-sub">Net PnL ÷ gross PnL</div>
            </div>
          </div>
        </div>
      </div>

      <!-- RISK & VOLATILITY -->
      <div class="metrics-block card-finance">
        <div class="metrics-block-header">
          <div>
            <span class="block-tag tag-risk">Risk</span>
            <h5>Risk & Volatility Profile</h5>
            <p class="block-subtext">How bad your bad days can get and how wild the swings are.</p>
          </div>
        </div>

        <div class="row g-3 mt-2">
          <!-- VaR -->
          <div class="col-md-6 col-xl-3">
            <div class="metric-chip risk-chip">
              <div class="metric-chip-label d-flex align-items-center justify-content-between">
                <span>Value at Risk (95%)</span>
                <i class="bi bi-info-circle-fill text-primary ms-1"
                   data-bs-toggle="tooltip"
                   data-bs-placement="top"
                   title="On a typical bad day, 95% of the time your loss should stay within this amount."></i>
              </div>
              <div class="metric-chip-value text-danger">
                ₹{{ '%.2f'|format(dm.value_at_risk_95 or 0) }}
              </div>
              <div class="metric-chip-sub">95th percentile loss</div>
            </div>
          </div>



          <!-- PnL Vol -->
          <div class="col-md-6 col-xl-3">
            <div class="metric-chip risk-chip">
              <div class="metric-chip-label d-flex align-items-center justify-content-between">
                <span>PnL Volatility</span>
                <i class="bi bi-info-circle-fill text-primary ms-1"
                   data-bs-toggle="tooltip"
                   data-bs-placement="top"
                   title="How much your daily profit/loss fluctuates. Higher = more unpredictable."></i>
              </div>
              <div class="metric-chip-value">
                ₹{{ '%.2f'|format(dm.pnl_volatility or 0) }}
              </div>
              <div class="metric-chip-sub">Standard deviation</div>
            </div>
          </div>

          <!-- Skew + Kurtosis (stacked) -->
          <div class="col-md-6 col-xl-3">
            <div class="metric-chip risk-chip mb-2">
              <div class="metric-chip-label d-flex align-items-center justify-content-between">
                <span>PnL Skewness</span>
                <i class="bi bi-info-circle-fill text-primary ms-1"
                   data-bs-toggle="tooltip"
                   data-bs-placement="top"
                   title="Tells you if losses are typically deeper than gains (negative skew) or vice versa."></i>
              </div>
              <div class="metric-chip-value {{ 'text-success' if (dm.pnl_skewness or 0)>0 else 'text-danger' }}">
                {{ '%.2f'|format(dm.pnl_skewness or 0) }}
              </div>
              <div class="metric-chip-sub">Distribution asymmetry</div>
            </div>
          </div>
            <div class="col-md-6 col-xl-3">
            <div class="metric-chip risk-chip">
              <div class="metric-chip-label d-flex align-items-center justify-content-between">
                <span>PnL Kurtosis</span>
                <i class="bi bi-info-circle-fill text-primary ms-1"
                   data-bs-toggle="tooltip"
                   data-bs-placement="top"
                   title="Tail risk: how often extreme profit/loss days show up. Higher = fatter tails."></i>
              </div>
              <div class="metric-chip-value">
                {{ '%.2f'|format(dm.pnl_kurtosis or 0) }}
              </div>
              <div class="metric-chip-sub">Tail risk indicator</div>
            </div>
          </div>
        </div>
      </div>

      <!-- WIN / LOSS + RISK / REWARD -->
      <div class="metrics-block card-finance">
        <div class="row g-4 align-items-stretch">

          <!-- Win/Loss distribution -->
          <div class="col-md-6">
            <div class="metrics-block-inner">
              <div class="metrics-block-header mb-2">
                <span class="block-tag tag-pnl">Win / Loss</span>
                <h6 class="mb-1">Outcome per Trade</h6>
                <p class="block-subtext mb-0">How big your average and extreme wins/losses are.</p>
              </div>
              <div class="stat-grid compact-grid">
                <div class="metric-chip gradient-chip-success">
                  <div class="metric-chip-label">Avg Win</div>
                  <div class="metric-chip-value text-success">₹{{ '%.2f'|format(dm.avg_win or 0) }}</div>
                  <div class="metric-chip-sub">Per winning trade</div>
                </div>
                <div class="metric-chip">
                  <div class="metric-chip-label">Largest Win</div>
                  <div class="metric-chip-value text-success">₹{{ '%.2f'|format(dm.largest_win or 0) }}</div>
                  <div class="metric-chip-sub">Best trade</div>
                </div>
                <div class="metric-chip gradient-chip-danger">
                  <div class="metric-chip-label">Avg Loss</div>
                  <div class="metric-chip-value text-danger">₹{{ '%.2f'|format(dm.avg_loss or 0) }}</div>
                  <div class="metric-chip-sub">Per losing trade</div>
                </div>
                <div class="metric-chip">
                  <div class="metric-chip-label">Largest Loss</div>
                  <div class="metric-chip-value text-danger">₹{{ '%.2f'|format(dm.largest_loss or 0) }}</div>
                  <div class="metric-chip-sub">Worst trade</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Risk / Reward -->
          <div class="col-md-6">
            <div class="metrics-block-inner">
              <div class="metrics-block-header mb-2">
                <span class="block-tag tag-riskreward">Risk / Reward</span>
                <h6 class="mb-1">Reward vs Risk Balance</h6>
                <p class="block-subtext mb-0">How much you earn when right vs lose when wrong.</p>
              </div>

              <div class="row g-3 mt-1">
                <div class="col-12">
                  <div class="metric-chip">
                    <div class="metric-chip-label">Reward to Risk</div>
                    <div class="metric-chip-value {{ 'text-success' if (dm.reward_to_risk_balance or 0)>2 else 'text-danger' }}">
                      {{ '%.2f'|format(dm.reward_to_risk_balance or 0) }}
                    </div>
                    <div class="metric-chip-sub">Target ≥ 2.0</div>
                  </div>
                </div>
                <div class="col-6">
                  <div class="metric-chip gradient-chip-success">
                    <div class="metric-chip-label">Avg Gainer %</div>
                    <div class="metric-chip-value text-success">
                      {{ '%.2f'|format(dm.avg_gainer_pct or 0) }}%
                    </div>
                    <div class="metric-chip-sub">Winning positions</div>
                  </div>
                </div>
                <div class="col-6">
                  <div class="metric-chip gradient-chip-danger">
                    <div class="metric-chip-label">Avg Loser %</div>
                    <div class="metric-chip-value text-danger">
                      {{ '%.2f'|format(dm.avg_loser_pct or 0) }}%
                    </div>
                    <div class="metric-chip-sub">Losing positions</div>
                  </div>
                </div>
              </div>

            </div>
          </div>

        </div>
      </div>

    </div>

    <!-- ========== RIGHT COLUMN (rhythm + scores) ========== -->
    <div class="col-lg-4 d-flex flex-column gap-4">

      <!-- TRADING ACTIVITY -->
      <div class="metrics-block card-finance tall">
        <div class="metrics-block-header mb-2">
          <span class="block-tag tag-activity">Rhythm</span>
          <h5 class="mb-1">Trading Activity</h5>
          <p class="block-subtext mb-0">How frequently you trade and how long you hold positions.</p>
        </div>

        <div class="stat-grid compact-grid mt-2">
          <div class="metric-chip">
            <div class="metric-chip-label">Avg Trades / Day</div>
            <div class="metric-chip-value">
              {{ '%.1f'|format(dm.avg_trades_per_day or 0) }}
            </div>
            <div class="metric-chip-sub">Daily frequency</div>
          </div>
          <div class="metric-chip">
            <div class="metric-chip-label">Avg Holding Period</div>
            <div class="metric-chip-value">
              {{ '%.0f'|format(dm.avg_holding_period or 0) }}
            </div>
            <div class="metric-chip-sub">Minutes per position</div>
          </div>
          <div class="metric-chip gradient-chip-success">
            <div class="metric-chip-label">Consecutive Wins</div>
            <div class="metric-chip-value text-success">{{ dm.consecutive_wins or 0 }}</div>
            <div class="metric-chip-sub">Best win streak</div>
          </div>
          <div class="metric-chip gradient-chip-danger">
            <div class="metric-chip-label">Consecutive Losses</div>
            <div class="metric-chip-value text-danger">{{ dm.consecutive_losses or 0 }}</div>
            <div class="metric-chip-sub">Worst loss streak</div>
          </div>
        </div>
      </div>

      <!-- TRADE QUALITY SCORES -->
      <div class="metrics-block card-finance tall">
        <div class="metrics-block-header mb-2">
          <span class="block-tag tag-quality">Quality</span>
          <h5 class="mb-1">Trade Quality & Score Stability</h5>
          <p class="block-subtext mb-0">How strong and consistent your scoring framework is.</p>
        </div>

        <div class="quality-grid mt-2">
          <!-- Core scores -->
          <div class="quality-row">
            <div class="quality-label">Avg F-Score</div>
            <div class="quality-value">{{ '%.1f'|format(dm.avg_f_score or 0) }}</div>
            <div class="quality-bar">
              <span style="width: {{ dm.avg_f_score or 0 }}%"></span>
            </div>
          </div>

          <div class="quality-row">
            <div class="quality-label">Avg T-Score</div>
            <div class="quality-value">{{ '%.1f'|format(dm.avg_t_score or 0) }}</div>
            <div class="quality-bar">
              <span style="width: {{ dm.avg_t_score or 0 }}%"></span>
            </div>
          </div>

          <div class="quality-row">
            <div class="quality-label">Avg Total Score</div>
            <div class="quality-value">{{ '%.1f'|format(dm.avg_total_score or 0) }}</div>
            <div class="quality-bar">
              <span style="width: {{ dm.avg_total_score or 0 }}%"></span>
            </div>
          </div>

          <!-- Volatilities -->
          <div class="quality-row mt-3">
            <div class="quality-label">F-Score Volatility</div>
            <div class="quality-value small-val">
              {{ '%.1f'|format(dm.f_score_volatility or 0) }}
            </div>
          </div>

          <div class="quality-row">
            <div class="quality-label">T-Score Volatility</div>
            <div class="quality-value small-val">
              {{ '%.1f'|format(dm.t_score_volatility or 0) }}
            </div>
          </div>

          <div class="quality-row">
            <div class="quality-label">Total Score Volatility</div>
            <div class="quality-value small-val">
              {{ '%.1f'|format(dm.total_score_volatility or 0) }}
            </div>
          </div>
        </div>
      </div>

      <!-- SCORE PERFORMANCE -->
      <div class="metrics-block card-finance tall">
        <div class="metrics-block-header mb-2">
          <span class="block-tag tag-signal">Signals</span>
          <h5 class="mb-1">Score-Driven Performance</h5>
          <p class="block-subtext mb-0">How well your high-score trades are paying off.</p>
        </div>

        <div class="stat-grid compact-grid mt-2">
          <div class="metric-chip gradient-chip-success">
            <div class="metric-chip-label">High-Score Win Rate</div>
            <div class="metric-chip-value text-success">
              {{ '%.1f'|format(dm.high_score_win_rate or 0) }}%
            </div>
            <div class="metric-chip-sub">When score ≥ 70</div>
          </div>

          <div class="metric-chip gradient-chip-danger">
            <div class="metric-chip-label">Low-Score Loss Rate</div>
            <div class="metric-chip-value text-danger">
              {{ '%.1f'|format(dm.low_score_loss_rate or 0) }}%
            </div>
            <div class="metric-chip-sub">When score &lt; 50</div>
          </div>

          <div class="metric-chip">
            <div class="metric-chip-label">52W High Hit Rate</div>
            <div class="metric-chip-value">
              {{ '%.1f'|format(dm.hit_rate_52w_high or 0) }}%
            </div>
            <div class="metric-chip-sub">Near 52-week highs</div>
          </div>

          <div class="metric-chip">
            <div class="metric-chip-label">52W Low Hit Rate</div>
            <div class="metric-chip-value">
              {{ '%.1f'|format(dm.hit_rate_52w_low or 0) }}%
            </div>
            <div class="metric-chip-sub">Near 52-week lows</div>
          </div>

          <div class="metric-chip">
            <div class="metric-chip-label">All-Time High Hit Rate</div>
            <div class="metric-chip-value">
              {{ '%.1f'|format(dm.hit_rate_alltime_high or 0) }}%
            </div>
            <div class="metric-chip-sub">At all-time highs</div>
          </div>
        </div>
      </div>

    </div> <!-- /right column -->

  </div> <!-- /row -->
</section>
